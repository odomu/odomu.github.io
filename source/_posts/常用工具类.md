---
title: 常用工具类
date: 2022-12-23
description: 常用工具类
---

## HttpUtil(连接池)
``` java
/**
 * 带连接池的http访问工具
 */
@Slf4j
public class HttpUtil {
    // PHttpClient连接池管理
    public static PoolingHttpClientConnectionManager cm = null;
    // httpClient
    public static CloseableHttpClient httpClient = null;
    // 默认超时时间
    private static final int DEFAULT_TIME_OUT = 60;
    // 最大连接数
    private static final int COUNT = 60;
    // 最多连接数
    private static final int TOTAL_COUNT = 80;
    // 连接存活时间
    private static final int HTTP_DEFAULT_KEEP_TIME = 15;

    /**
     * 初始化连接池
     */
    public static void initPools() throws Exception {
        if (httpClient == null) {
            // 忽略https证书验证
            SSLContext sslContext = SSLContexts.custom().useTLS().loadTrustMaterial(null, (x509Certificates, s) -> true).build();
            Registry<ConnectionSocketFactory> registry = RegistryBuilder.<ConnectionSocketFactory>create()
                    .register("http", PlainConnectionSocketFactory.getSocketFactory())
                    .register("https", new SSLConnectionSocketFactory(sslContext, SSLConnectionSocketFactory.ALLOW_ALL_HOSTNAME_VERIFIER))
                    .build();
            // 开启连接池
            cm = new PoolingHttpClientConnectionManager(registry);
            cm.setDefaultMaxPerRoute(COUNT);
            cm.setMaxTotal(TOTAL_COUNT);
            // 设置连接重试
            HttpRequestRetryHandler httpRequestRetryHandler = (exception, executionCount, context) -> {
                if (executionCount >= 3) {
                    return false;
                } else if (exception instanceof NoHttpResponseException) {
                    return true;
                } else if (exception instanceof SSLHandshakeException) {
                    return false;
                } else if (exception instanceof InterruptedIOException) {
                    return false;
                } else if (exception instanceof UnknownHostException) {
                    return false;
                } else if (exception instanceof ConnectTimeoutException) {
                    return false;
                } else if (exception instanceof SSLException) {
                    return false;
                } else {
                    HttpClientContext clientContext = HttpClientContext.adapt(context);
                    HttpRequest request = clientContext.getRequest();
                    return !(request instanceof HttpEntityEnclosingRequest);
                }
            };
            // 创建httpClient
            httpClient = HttpClients.custom()
                    .setConnectionManager(cm)
                    .setKeepAliveStrategy(connectionKeepAliveStrategy)
                    .setRetryHandler(httpRequestRetryHandler)
                    .evictExpiredConnections()
                    .evictIdleConnections(30, TimeUnit.SECONDS)
                    .build();
        }
    }

    public static CloseableHttpClient getHttpClient() {
        return httpClient;
    }

    public static PoolingHttpClientConnectionManager getHttpConnectionManager() {
        return cm;
    }

    public static String doPost(String url,
                                Map<String, String> params,
                                Map<String, String> headers,
                                String contentType,
                                int timeout) {
        List<NameValuePair> pairs = new ArrayList<>();
        if (ObjectUtil.isNotEmpty(params)) {
            for (String key : params.keySet()) {
                pairs.add(new BasicNameValuePair(key, params.get(key)));
            }
        }
        return executePost(url, pairs, headers, contentType, timeout);
    }

    /**
     * 执行post请求
     * @param uri 请求链接
     * @param pairs 请求参数
     * @param headers 请求头
     * @param contentType 内容类型
     * @param timeout 请求超时
     * @return 请求结果
     */
    public static String executePost(String uri,
                                     List<NameValuePair> pairs,
                                     Map<String, String> headers,
                                     String contentType,
                                     int timeout) {
        HttpEntity httpEntity = null;
        HttpEntityEnclosingRequestBase method = null;
        String responseBody = "";
        try {
            if (httpClient == null) {
                initPools();
            }
            contentType = contentType == null ? MediaType.APPLICATION_FORM_URLENCODED_VALUE : contentType;
            method = (HttpEntityEnclosingRequestBase) getRequestMethod(uri, HttpPost.METHOD_NAME, contentType, timeout, headers);
            StringEntity stringEntity = null;
            // 判断是否json
            if (MediaType.APPLICATION_JSON_UTF8_VALUE.contains(contentType)) {
                JSONObject paramMap = new JSONObject();
                if (pairs != null && pairs.size() > 0) {
                    for (NameValuePair pair : pairs) {
                        paramMap.put(pair.getName(), pair.getValue());
                    }
                }
                String string = (pairs != null && pairs.size() != 0) ? paramMap.toString() : "";
                stringEntity = new StringEntity(string, ContentType.APPLICATION_JSON);
            } else {
                stringEntity = new UrlEncodedFormEntity(pairs, StandardCharsets.UTF_8);
            }
            stringEntity.setContentEncoding(StandardCharsets.UTF_8.name());
            stringEntity.setContentType(contentType);
            method.setEntity(stringEntity);
            HttpContext context = HttpClientContext.create();
            // 发送请求
            CloseableHttpResponse httpResponse = httpClient.execute(method, context);
            httpEntity = httpResponse.getEntity();
            if (httpEntity != null) {
                responseBody = EntityUtils.toString(httpEntity, StandardCharsets.UTF_8);
            }
        } catch (Exception e) {
            if (method != null) {
                method.abort();
            }
        } finally {
            if (httpEntity != null) {
                try {
                    EntityUtils.consumeQuietly(httpEntity);
                } catch (Exception e) {
                    log.error("exception", e);
                }
            }
        }
        return responseBody;
    }

    /**
     * 执行get请求
     * @param uri 请求链接
     * @param headers 请求头
     * @param contentType 内容类型
     * @param timeout 请求超时
     * @return 请求结果
     */
    public static String executeGet(String uri,
                                    Map<String, String> headers,
                                    String contentType,
                                    int timeout) {
        HttpEntity httpEntity = null;
        HttpRequestBase method = null;
        String responseBody = "";
        try {
            if (httpClient == null) {
                initPools();
            }
            contentType = contentType == null ? MediaType.APPLICATION_FORM_URLENCODED_VALUE : contentType;
            method = getRequestMethod(uri, HttpGet.METHOD_NAME, contentType, timeout, headers);
            HttpContext context = HttpClientContext.create();
            CloseableHttpResponse httpResponse = httpClient.execute(method, context);
            httpEntity = httpResponse.getEntity();
            if (httpEntity != null) {
                responseBody = EntityUtils.toString(httpEntity, StandardCharsets.UTF_8);
            }
        } catch (Exception e) {
            if (method != null) {
                method.abort();
            }
            log.error("exception", e);
        } finally {
            if (httpEntity != null) {
                try {
                    EntityUtils.consumeQuietly(httpEntity);
                } catch (Exception e) {
                    log.error("exception", e);
                }
            }
        }
        return responseBody;
    }

    private static final ConnectionKeepAliveStrategy connectionKeepAliveStrategy = (response, context) -> {
        HeaderElementIterator it = new BasicHeaderElementIterator(response.headerIterator(HTTP.CONN_KEEP_ALIVE));
        while (it.hasNext()) {
            HeaderElement he = it.nextElement();
            String param = he.getName();
            String value = he.getValue();
            if (value != null && "timeout".equalsIgnoreCase(param)) {
                try {
                    return Long.parseLong(value) * 1000;
                } catch (Exception e) {
                    log.error("exception", e);
                }
            }
        }
        return HTTP_DEFAULT_KEEP_TIME * 1000L;
    };

    /**
     * 获取Http请求方法
     * @param uri 请求链接
     * @param methodName 请求方式
     * @param contentType 内容类型
     * @param timeout 超时时间
     * @param headers 请求头
     * @return Http请求方法
     */
    private static HttpRequestBase getRequestMethod(String uri,
                                                    String methodName,
                                                    String contentType,
                                                    int timeout,
                                                    Map<String, String> headers) throws Exception {
        if (httpClient == null) {
            initPools();
        }
        HttpRequestBase method = null;
        if (timeout <= 0) {
            timeout = DEFAULT_TIME_OUT;
        }
        RequestConfig requestConfig = RequestConfig.custom()
                .setSocketTimeout(timeout * 1000)
                .setConnectTimeout(timeout * 1000)
                .setConnectionRequestTimeout(timeout * 1000)
                .setContentCompressionEnabled(true)
                .setRedirectsEnabled(true)
                .setRelativeRedirectsAllowed(true)
                .build();
        if (HttpPut.METHOD_NAME.equalsIgnoreCase(methodName)) {
            method = new HttpPut(uri);
        } else if (HttpPost.METHOD_NAME.equalsIgnoreCase(methodName)) {
            method = new HttpPost(uri);
        } else if (HttpGet.METHOD_NAME.equalsIgnoreCase(methodName)) {
            method = new HttpGet(uri);
        } else {
            method = new HttpPost(uri);
        }
        if (contentType == null || "".equals(contentType)) {
            contentType = MediaType.APPLICATION_FORM_URLENCODED_VALUE;
        }
        if (headers != null && headers.keySet().size() > 0) {
            for (String key : headers.keySet()) {
                method.addHeader(key, headers.get(key));
            }
        }
        method.addHeader("Content-Type", contentType);
        method.addHeader("Accept", contentType);
        method.setConfig(requestConfig);
        return method;
    }
}
```

## 
